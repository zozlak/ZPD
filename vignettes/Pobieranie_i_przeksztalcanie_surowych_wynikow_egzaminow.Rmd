---
title: "Pobieranie i przekształcanie surowych wyników egzaminów"
author: "Filip Kulon"
date: "2015-03-11"
output:
  html_document:
    number_sections: yes
---

# Wymagania
Załadujmy potrzebne pakiety i nawiążmy połączenie z bazą:
```{r, cache = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
library("ZPD")
library("ggplot2")
src = polacz()
```

# Uwagi dotyczące danych
Pobieranie danych z bazy zajmuje dużo czasu. Na potrzeby warsztatów dane zostały pobrane wcześniej i zapisane przy użyciu funkcji `save()` do plików *.RData*. Dzięki temu można je szybko wczytać przy użyciu funkcji `load()`.
Polecenia pobierające dane z bazy są poprzedzone znakiem komentarza (#), aby były nieaktywne i nie zostały przez przypadek uruchomione. Zamiast nich aktywne są polecenia wczytujące dane z plików (w takiej formie, jak zwróciłaby je baza).

# Pobieranie wyników surowych

Do pobierania surowych wyników służy funkcja `pobierz_wyniki_egzaminu()`, dla której pomoc można wyświetlić za pomocą polecenia `?pobierz_wyniki_egzaminu`.

Jej składnia jest następująca:  
`pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd, punktuj = TRUE, idSkali = NULL, skroc = TRUE)`  
argumenty:  
*src* - uchwyt źródła danych dplyr-a  
*rodzajEgzaminu* - rodzaj egzaminu, ktorego wyniki maja zostac pobrane  
*czescEgzaminu* - czesc egzaminu, ktorego wyniki maja zostac pobrane  
*rokEgzaminu* - rok egzaminu, ktorego wyniki maja zostac pobrane  
*czyEwd* - wybor, czy maja byc pobrane wyniki gromadzone przez EWD, czy PAOU  
*punktuj* - wybor, czy dane maja byc pobrane w postaci dystraktorow, czy punktow  
*idSkali* - identyfikator skali, ktora ma zostac zastosowana do danych  
*skroc* - czy do danych zastosowac skrocenia skal opisane w skali  

Najkrótsze zastosowanie tej funkcji to `pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd)` (domyślnie zwraca ona punkty, a nie dystraktory i nie jest stosowana żadna skala).

## Ćwiczenie 1
Pobierzmy wyniki z matematyki z egzaminu gimnazjalnego z 2014 roku:

1. Sprawdzamy, jaki to rodzaj i część egzaminu - http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu
2. Sprawdzamy, czy będą to *dane EWD* czy *dane PAOU* - http://zpd.ibe.edu.pl/doku.php?id=obazie
3. Pobieramy dane:
    ```{r, cache = TRUE, eval = TRUE}
    # UWAGA! Wykonywanie tego polecenia może zająć kilkanaście minut.
    # gmm14.surowe = pobierz_wyniki_egzaminu(src, "egzamin gimnazjalny", "matematyka", 2014, TRUE) %>% collect()
    load("~/gmm14.surowe.RData")
    head(gmm14.surowe)
    ```

## Ćwiczenie 2
Przeprowadźmy jakieś operacje na pobranych danych:

1. Bardzo często interesuje nas wynik ucznia z całego egzaminu, a więc musimy zsumować punktację za wszystkie zadania. Do tego celu służy funkcja `zsumuj_punkty()` (pomoc: `?zsumuj_punkty`).

    Jej składnia jest następująca:
    `zsumuj_punkty(dane, usunKryteria = TRUE)`  
    argumenty:  
    *dane* - wynik dzialania dowolnej z funkcji `pobierz_wyniki_...()`  
    *usunKryteria* - czy usuwac ze zbioru kolumny z wynikami za poszczegolne kryteria

    UWAGA: Domyślnie (przy podaniu tylko nazwy danych, które chcemy zsumować) funkcja `zsumuj_punkty()` usuwa punktację za poszczególne zadania!

    a) Stwórzmy zmienną zawierającą sumy punktów uczniów z pobranych danych z matematyki:
        ```{r, cache = TRUE, eval = TRUE}
        gmm14.surowe.sumy = zsumuj_punkty(gmm14.surowe)
        head(gmm14.surowe.sumy)
        ```
    b) Dodajmy zmienną zawierającą sumy punktów uczniów do pobranych danych z matematyki:
        ```{r, cache = TRUE, eval = TRUE}
        gmm14.surowe = zsumuj_punkty(gmm14.surowe, FALSE)
        head(gmm14.surowe)
        ```

2. Stwórzmy histogram zsumowanych wyników:
    a) za pomocą podstawowej funkcji `hist()`:
        ```{r, cache = TRUE, eval = TRUE}
        hist(gmm14.surowe.sumy$wynik, col = "orange", main = "hist()", xlab = "wyniki", ylab = "częstość")
        
        # alternatywnie ze składnią pakietu dplyr konieczne jest wyłuskanie wartości z wybranej kolumny
        gmm14.surowe.sumy %>% select(wynik) %>% .[[1]] %>% hist(col = "blue", main = "hist()", xlab = "wyniki", ylab = "częstość")
        # lub bez użycia funkcji select()
        gmm14.surowe.sumy %>% .[["wynik"]] %>% hist(col = "red", main = "hist()", xlab = "wyniki", ylab = "częstość")
        ```
    b) za pomocą funkcji `qplot()` z biblioteki *ggplot2*:
        ```{r, cache = TRUE, eval = TRUE}
        # kolor musimy zdefiniować poprzez funkcję I()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = I("orange"), main = "qplot()", xlab = "wyniki", ylab = "częstość")
        
        # można porównać z wynikiem bez użycia funkcji I()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = "orange", main = "qplot()", xlab = "wyniki", ylab = "częstość")
        ```
    * Wykresy wyglądają "dziwnie", otrzymaliśmy informację o parametrze *binwidth* ("koszyku"). Co się stało?
    c) za pomocą funkcji `ggplot()` z biblioteki *ggplot2*:
        ```{r, cache = TRUE, eval = TRUE}
        # dodatkowo ustawiamy szerokość "koszyków"
        gmm14.surowe.sumy %>% ggplot(aes(wynik)) + geom_histogram(fill = "orange", binwidth = 1) + ggtitle("ggplot()") + xlab("wyniki") + ylab("częstość")
        
        # szerokość "koszyków" można ustawić również w funkcji qplot()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = I("orange"), binwidth = 1, main = "qplot()", xlab = "wyniki", ylab = "częstość")
        
        # i funkcji hist()
        hist(gmm14.surowe.sumy$wynik, col = "orange", main = "hist()", xlab = "wyniki", ylab = "częstość", breaks = 10)
        ```
  * Czy ma znaczenie, którego obiektu użyjemy: `gmm14.surowe.sumy` czy `gmm14.surowe`?

## Ćwiczenie 3
Pobierzmy dystraktory z przyrody z egzaminu gimnazjalnego z 2014 roku:

1. Sprawdzamy, jaki to rodzaj i część egzaminu - http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu  
    * [ZAAWANSOWANE] możemy to samo uzyskać za pomocą bazy;  
    znajduje się w niej tabela **sl_czesci_egzaminow**, która zawiera potrzebne nam informacje;  
    pobieramy z niej dane i filtrujemy tylko dane dotyczące egzaminu gimnazjalnego:
        ```{r, cache = TRUE, eval = TRUE}
        czesci = tbl(src, "sl_czesci_egzaminow") %>% collect() #pobieramy tabelę z częściami egzaminów
        head(czesci) #wyświetlamy kilka wierszy pobranej tabeli
        czesci %>% filter(rodzaj_egzaminu == "egzamin gimnazjalny") #filtrujemy tylko części dla egzaminu gimnazjalnego
        ```
2. Sprawdzamy, czy będą to *dane EWD* czy *dane PAOU* - http://zpd.ibe.edu.pl/doku.php?id=obazie
3. Pobieramy dane:
    ```{r, cache = TRUE, eval = TRUE}
    # UWAGA! Wykonywanie tego polecenia może zająć kilkanaście minut!
    # gmp14.surowe.dys = pobierz_wyniki_egzaminu(src, "egzamin gimnazjalny", "przedmioty przyrodnicze", 2014, TRUE, FALSE) %>% collect()
    load("~/gmp14.surowe.dys.RData")
    head(gmp14.surowe.dys)
    ```

## Ćwiczenie 4
Wyświetlmy tabelę częstości z wyborami odpowiedzi dla jakiegoś zadania:

1. Sprawdzamy, jaki jest identyfikator zadania, które nas interesuje w wyszukiwarce zadań - http://zpd.ibe.edu.pl/doku.php?id=bazatestypytania
2. Wyświetlmy tabelę częstości dla wybranego zadania:
    ```{r, cache = TRUE, eval = TRUE}
    gmp14.surowe.dys %>% select(k_7447) %>% table()
    ```
  * Znaczenie kodów odpowiedzi możemy sprawdzić pod adresem http://zpd.ibe.edu.pl/doku.php?id=obazie
  * Czy utworzona tabela jest poprawna?
3. Wyświetlmy tabelę częstości dla wybranego zadania w podziale na wersje testu i tylko poprawne zaznaczenia:
    ```{r, cache = TRUE, eval = TRUE}
    gmp14.surowe.dys %>% select(id_testu, k_7447) %>% filter(k_7447 > 0) %>% table()
    ```
  * Wersje testu możemy sprawdzić również pod adresem http://zpd.ibe.edu.pl/doku.php?id=bazatestypytania

    * [ZAAWANSOWANE] możemy użyć tylko składni i funkcji biblioteki *dplyr*;  
    oprócz częstości dodatkowo obliczymy procenty:
        ```{r, cache = TRUE, eval = TRUE}
        gmp14.surowe.dys %>% group_by(id_testu, k_7447) %>% filter(k_7447 > 0) %>% summarize(n = n()) %>% mutate(proc = n / sum(n))
        ```

# Normalizacja ekwikwantylowa

Mając dane ze zsumowanymi punktami możemy dokonać normalizacji ekwikwantylowej.

W tym celu korzystamy z funkcji `normalizuj_ekwikwantylowo()` (pomoc: `?normalizuj_ekwikwantylowo`).
    Jej składnia jest następująca:
    `normalizuj_ekwikwantylowo(dane, src = NULL, kolWynik = "wynik", idSkali = NULL, ...)`  
    argumenty:  
    *dane* - ramka danych zawierająca wyniki  
    *src* - uchwyt źródła danych dplyr-a (gdy normalizacja na podstawie norm w bazie)  
    *kolWynik* - nazwa kolumny zawierającej wyniki  
    *idSkali* - skala, której norma z bazy ma zostać zastosowana  
    *...* - ew. parametry funkcji normy_ekwikwantylowe() (gdy normalizacja na podstawie danych)  

Dostępne są dwie metody:

* z normami wyliczanymi na podstawie danych (domyślnie),
* z normami wczytanymi z bazy (wyliczonymi na potrzeby *Kalkulatora EWD*).

## Ćwiczenie 5
Wyliczmy normy z danych:

```{r, cache = TRUE, eval = TRUE}
gmm14.surowe.sumy = normalizuj_ekwikwantylowo(gmm14.surowe.sumy)
head(gmm14.surowe.sumy)
```

## Ćwiczenie 6
Wyliczmy normy z Kalkulatora EWD.

Zastosowanie norm z Kalkulatora EWD wymaga zastosowania *skali*.
*Skala* opisuje przekształcenia danych takiej jak sumowanie kryteriów oceny czy skracanie skal punktowych.
Musimy zatem:

1. Znaleźć stosowną skalę za pomocą funkcji `pobierz_skale()`.
2. Znormalizować wyniki.

```{r, cache = TRUE, eval = TRUE}
# 1. wyszukujemy skalę
pobierz_skale(src) %>%
  filter(normy_ekwikwantylowe == TRUE, rodzaj_egzaminu == "egzamin gimnazjalny", czesc_egzaminu == "matematyka", rok == 2014)
```
Spośród wyświetlonych skal nas interesuje skala 723 (dotyczy tylko części *gm_m* - patrz kolumna *nazwa_skali*)
```{r, cache = TRUE, eval = TRUE}
# 2. normalizujemy (dodatkowo zmieniając nazwę poprzedniej normalizacji, żeby móc porównać wyniki)
gmm14.surowe.sumy = gmm14.surowe.sumy %>% rename(wynik_norm_dane = wynik_norm) %>% normalizuj_ekwikwantylowo(src, idSkali = 723)
head(gmm14.surowe.sumy)
```

Porównajmy wyniki przed i po normalizacji:
```{r, cache = TRUE, eval = TRUE}
# wyniki surowe
gmm14.surowe.sumy %>% ggplot(aes(wynik)) + 
  geom_density(color = "orange", size = 3, adjust = 2)

# porównanie wyników znormalizowanych
gmm14.surowe.sumy %>% ggplot() +
  geom_density(aes(wynik_norm_dane), color = "orange", size = 3, adjust = 2) +
  geom_density(aes(wynik_norm), color = "blue", size = 3, adjust = 2)
```

# Pomijanie uczniów przystępujących wielokrotnie do egzaminu

Czasami (w wypadku EWD na ogół) interesować mogą nas tylko uczniowie piszący dany egzamin po raz pierwszy (na wyjściu) lub ostatni (na wejściu).

Do ich odfiltrowywania służy funkcja `filtruj_przystapienia()` (pomoc: `?filtruj_przystapienia`). Dla wskazanego *rodzaju egzaminu* (lub tylko dla wybranej *części egzaminu*) oraz określenia z jakiego źródła (EWD/PAOU) mają pochodzić dane, zwraca ona zbiór zawierający jedynie pierwsze lub ostatnie przystąpienia uczniów do danego egzaminu.

Jej składnia jest następująca:  
`filtruj_przystapienia(src, pierwsze, rodzajEgzaminu, czescEgzaminu = NULL, czyEwd, obserwacje = NULL)`  
argumenty:  
*src* - uchwyt źródła danych dplyr-a  
*pierwsze* - czy odfiltrować pierwsze podejście (jeśli FALSE, odfiltrowane zostanie ostatnie)  
*rodzajEgzaminu* - rodzaj egzaminu - patrz http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu  
*czescEgzaminu* - wektor części egzaminu - patrz http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu  
*czyEwd* - czy korzystać z danych EWD czy PAOU (patrz opis)  
*obserwacje* - wektor id_obserwacji lub ramka danych z kolumną id_obserwacji  

Za pomocą złączenia *inner_join* lub filtrowania *semi_join* można odfiltrować pożądane wyniki egzaminu lub oszacowania umiejętności uczniów.

Złączmy przygotowane powyżej sumy punktów z informacjami o pierwszym przystąpieniu do egzaminu gimnazjalnego:
* sprawdzając przystąpienia tylko w obrębie części egzaminu *matematyka*,
* sprawdzając przystąpienia w obrębie całego egzaminu gimnazjalnego.

W obydwu wypadkach dla *danych EWD*, bo właśnie na takich danych mamy policzone sumy punktów.
```{r, cache = TRUE, eval = TRUE}
# UWAGA! Wykonywanie tych poleceń może zająć kilka minut.
# filtrMat = filtruj_przystapienia(src, TRUE, "egzamin gimnazjalny", "matematyka", TRUE) %>% collect()
# filtrGim = filtruj_przystapienia(src, TRUE, "egzamin gimnazjalny", NULL, TRUE) %>% collect()
load("~/filtry.RData")
head(filtrMat)
head(filtrGim)

# filtrujemy
gmm14.filtrMat = gmm14.surowe.sumy %>% inner_join(filtrMat)
gmm14.filtrGim = gmm14.surowe.sumy %>% inner_join(filtrGim)

# jaka jest różnica w liczbie obserwacji?
nrow(gmm14.filtrMat) - nrow(gmm14.filtrGim)
```
* Z czego wynika różnica w liczbie obserwacji pomiędzy jednym i drugim sposobem filtrowania?

# Złączanie danych pomiędzy egzaminami

Na wstępie warto zaznaczyć, że **nie wszystkie wyniki egzaminacyjne i oszacowania umiejętności uczniów są łączliwe między latami**. Szczegółowe informacje znajdują się pod adresem http://zpd.ibe.edu.pl/doku.php?id=obazie

Złączanie następuje wprost po *id_obserwacji*, więc co najwyżej dane się nie połączą.

Warto jeszcze zauważyć, że złączane zbiory mogą zawierać jednakowo nazywające się kolumny (np. _wynik_, _dysleksja_, itp.), które przed złączeniem należy zmienić im nazwy (np. na *wynik_spr*, *wynik_gh*, *dysleksja_spr*, *dysleksja_gh* itd.).

Przyłączmy do policzonych sum surowych punktów z egzaminu GMM 2014 wyniki sprawdzianu 2011.
W tym celu musimy:
1. Pobrać wyniki sprawdzianu 2011 z danych EWD (dodatkowo policzymy sumę punktów).
```{r, cache = TRUE, eval = TRUE}
# UWAGA! Wykonywanie tego polecenia może zająć kilkanaście minut!
# spr11 = pobierz_wyniki_egzaminu(src, "sprawdzian", "", 2011, TRUE) %>% collect()
load("~/spr11.RData")
spr11 = zsumuj_punkty(spr11)
head(spr11)
```
2. Zmienić nazwy kolumn.
```{r, cache = TRUE, eval = TRUE}
spr11 = spr11 %>% rename(wynik_spr = wynik, rok_spr = rok, id_testu_spr = id_testu, id_szkoly_spr = id_szkoly)
head(spr11)
```
3. Połączyć wyniki z obydwu egzaminów.
```{r, cache = TRUE, eval = TRUE}
polaczone = gmm14.surowe.sumy %>% left_join(spr11)
head(polaczone)
```

Możemy sprawdzić, dla ilu uczniów połączyliśmy wyniki.
```{r, cache = TRUE, eval = TRUE}
polaczone %>% 
  group_by(is.na(rok_spr)) %>%
  summarize(n = n())
```
Jak widać nie przyłączyło się nieco ponad 27 tys. uczniów (np. o opóźnionym toku kształcenia).

## Ćwiczenie 7
Zróbmy wykres rozrzutu dla wyników obydwu egzaminów.

```{r, cache = TRUE, eval = TRUE}
#geom_point() utworzy wykres rozrzutu
polaczone %>% ggplot(aes(wynik, wynik_spr)) + geom_point()

#geom_jitter() doda nieco "szumu" do danych
polaczone %>% ggplot(aes(wynik, wynik_spr)) + geom_jitter()
```
