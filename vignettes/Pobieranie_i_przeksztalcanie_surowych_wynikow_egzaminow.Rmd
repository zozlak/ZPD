---
title: "Pobieranie i przekształcanie surowych wyników egzaminów"
author: "Filip Kulon"
date: '2015-03-11'
output:
  html_document:
    number_sections: yes
---

# Wymagania

Do wykonania ćwiczeń niezbędnę będą pakiety: *ZPD, ggplot2*, a także ich zależności (*dplyr, RPostgreSQL, reshape2*). Upewnijmy się więc, że wszystkie te pakiety posiadamy:
```{r, cache = TRUE, eval = F}
install.packages(c("devtools", "ggplot2", "dplyr", "RPostgreSQL", "reshape2", "plyr"))
devtools::install_github("zozlak/ZPD")
```

Załadujmy potrzebne pakiety i nawiążmy połączenie z bazą:
```{r, cache = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
library("ZPD")
library("ggplot2")
src <- polacz()
```

# Uwagi dotyczące danych
Pobieranie danych z bazy zajmuje dużo czasu. Na potrzeby warsztatów dane zostały pobrane wcześniej i zapisane przy użyciu funkcji `save()` do plików *.RData*. Dzięki temu można je szybko wczytać przy użyciu funkcji `load()`.
Polecenia pobierające dane z bazy są poprzedzone znakiem komentarza (#), aby były nieaktywne i nie zostały przez przypadek uruchomione. Zamiast nich aktywne są polecenia wczytujące dane z plików (w takiej formie, jak zwróciłaby je baza).

# Wyszukiwanie informacji

# Pobieranie wyników surowych

Do pobierania surowych wyników służy funkcja `pobierz_wyniki_egzaminu()`, dla której pomoc można wyświetlić za pomocą polecenia `?pobierz_wyniki_egzaminu`.

Jej składnia jest następująca:
`pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd, punktuj = TRUE, idSkali = NULL, skroc = TRUE)`  
argumenty:  
*src* - uchwyt źródła danych dplyr-a  
*rodzajEgzaminu* - rodzaj egzaminu, ktorego wyniki maja zostac pobrane  
*czescEgzaminu* - czesc egzaminu, ktorego wyniki maja zostac pobrane  
*rokEgzaminu* - rok egzaminu, ktorego wyniki maja zostac pobrane  
*czyEwd* - wybor, czy maja byc pobrane wyniki gromadzone przez EWD, czy PAOU  
*punktuj* - wybor, czy dane maja byc pobrane w postaci dystraktorow, czy punktow  
*idSkali* - identyfikator skali, ktora ma zostac zastosowana do danych  
*skroc* - czy do danych zastosowac skrocenia skal opisane w skali  

Najkrótsze zastosowanie tej funkcji to `pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd)` (domyślnie zwraca ona punkty, a nie dystraktory i nie jest stosowana żadna skala).

## Ćwiczenie 1
Pobierzmy wyniki z matematyki z egzaminu gimnazjalnego z 2014 roku:

1. Sprawdzamy, jaki to rodzaj i część egzaminu - http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu
2. Sprawdzamy, czy będą to *dane EWD* czy *dane CKE* - http://zpd.ibe.edu.pl/doku.php?id=obazie
3. Pobieramy dane:
    ```{r, cache = TRUE, eval = TRUE}
    # gmm14.surowe <- pobierz_wyniki_egzaminu(src, "egzamin gimnazjalny", "matematyka", 2014, TRUE) %>% collect()
    load("~/gmm14.surowe.RData")
    head(gmm14.surowe)
    ```

## Ćwiczenie 2
Przeprowadźmy jakieś operacje na pobranych danych:

1. Bardzo często interesuje nas wynik ucznia z całego egzaminu, a więc musimy zsumować punktację za wszystkie zadania. Do tego celu służy funkcja `zsumuj_punkty()` (pomoc: `?zsumuj_punkty`).

    Jej składnia jest następująca:
    `zsumuj_punkty(dane, usunKryteria = TRUE)`  
    argumenty:  
    *dane* - wynik dzialania dowolnej z funkcji `pobierz_wyniki_...()`  
    *usunKryteria* - czy usuwac ze zbioru kolumny z wynikami za poszczegolne kryteria

    UWAGA: Domyślnie (przy podaniu tylko nazwy danych, które chcemy zsumować) funkcja `zsumuj_punkty()` usuwa punktację za poszczególne zadania!

    a) Stwórzmy zmienną zawierającą sumy punktów uczniów z pobranych danych z matematyki:
        ```{r, cache = TRUE, eval = TRUE}
        gmm14.surowe.sumy <- zsumuj_punkty(gmm14.surowe)
        head(gmm14.surowe.sumy)
        ```
    b) Dodajmy zmienną zawierającą sumy punktów uczniów do pobranych danych z matematyki:
        ```{r, cache = TRUE, eval = TRUE}
        gmm14.surowe <- zsumuj_punkty(gmm14.surowe, FALSE)
        head(gmm14.surowe)
        ```

2. Stwórzmy histogram zsumowanych wyników:
    a) za pomocą podstawowej funkcji `hist()`:
        ```{r, cache = TRUE, eval = TRUE}
        hist(gmm14.surowe.sumy$wynik, col = "orange", main = "hist()", xlab = "wyniki", ylab = "częstość")
        
        # alternatywnie ze składnią pakietu dplyr konieczne jest wyłuskanie wartości z wybranej kolumny
        gmm14.surowe.sumy %>% select(wynik) %>% .[[1]] %>% hist(col = "blue", main = "hist()", xlab = "wyniki", ylab = "częstość")
        # lub bez użycia funkcji select()
        gmm14.surowe.sumy %>% .[["wynik"]] %>% hist(col = "red", main = "hist()", xlab = "wyniki", ylab = "częstość")
        ```
    b) za pomocą funkcji `qplot()` z biblioteki *ggplot2*:
        ```{r, cache = TRUE, eval = TRUE}
        # kolor musimy zdefiniować poprzez funkcję I()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = I("orange"), main = "qplot()", xlab = "wyniki", ylab = "częstość")
        
        # można porównać z wynikiem bez użycia funkcji I()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = "orange", main = "qplot()", xlab = "wyniki", ylab = "częstość")
        ```
    * Wykresy wyglądają "dziwnie", otrzymaliśmy informację o parametrze *binwidth* ("koszyku"). Co się stało?
    c) za pomocą funkcji `ggplot()` z biblioteki *ggplot2*:
        ```{r, cache = TRUE, eval = TRUE}
        # dodatkowo ustawiamy szerokość "koszyków"
        gmm14.surowe.sumy %>% ggplot(aes(wynik)) + geom_histogram(fill = "orange", binwidth = 1) + ggtitle("ggplot()") + xlab("wyniki") + ylab("częstość")
        
        # szerokość "koszyków" można ustawić również w funkcji qplot()
        gmm14.surowe.sumy %>% qplot(wynik, data = ., fill = I("orange"), binwidth = 1, main = "qplot()", xlab = "wyniki", ylab = "częstość")
        
        # i funkcji hist()
        hist(gmm14.surowe.sumy$wynik, col = "orange", main = "hist()", xlab = "wyniki", ylab = "częstość", breaks = 10)
        ```
  * Czy ma znaczenie, którego obiektu użyjemy: `gmm14.surowe.sumy` czy `gmm14.surowe`?

## Ćwiczenie 3
Pobierzmy dystraktory z przyrody z egzaminu gimnazjalnego z 2014 roku:

1. Sprawdzamy, jaki to rodzaj i część egzaminu - http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu  
    * [ZAAWANSOWANE] możemy to samo uzyskać za pomocą bazy;  
    znajduje się w niej tabela **sl_czesci_egzaminow**, która zawiera potrzebne nam informacje;  
    pobieramy z niej dane i filtrujemy tylko dane dotyczące egzaminu gimnazjalnego:
        ```{r, cache = TRUE, eval = TRUE}
        czesci <- tbl(src, "sl_czesci_egzaminow") %>% collect() #pobieramy tabelę z częściami egzaminów
        head(czesci) #wyświetlamy kilka wierszy pobranej tabeli
        czesci %>% filter(rodzaj_egzaminu == "egzamin gimnazjalny") #filtrujemy tylko części dla egzaminu gimnazjalnego
        ```
2. Sprawdzamy, czy będą to *dane EWD* czy *dane CKE* - http://zpd.ibe.edu.pl/doku.php?id=obazie
3. Pobieramy dane:
    ```{r, cache = TRUE, eval = TRUE}
    # gmp14.surowe.dys <- pobierz_wyniki_egzaminu(src, "egzamin gimnazjalny", "przedmioty przyrodnicze", 2014, TRUE, FALSE) %>% collect()
    load("~/gmp14.surowe.dys.RData")
    head(gmp14.surowe.dys)
    ```

## Ćwiczenie 4
Wyświetlmy tabelę częstości z wyborami odpowiedzi dla jakiegoś zadania.

1. Sprawdzamy, jaki jest identyfikator zadania, które nas interesuje w wyszukiwarce zadań - http://zpd.ibe.edu.pl/doku.php?id=bazatestypytania
2. Wyświetlmy tabelę częstości dla wybranego zadania:
    ```{r, cache = TRUE, eval = TRUE}
    gmp14.surowe.dys %>% select(k_7447) %>% table()
    ```
  * Znaczenie kodów odpowiedzi możemy sprawdzić pod adresem http://zpd.ibe.edu.pl/doku.php?id=obazie
  * Czy utworzona tabela jest poprawna?
3. Wyświetlmy tabelę częstości dla wybranego zadania w podziale na wersje testu i tylko poprawne zaznaczenia:
    ```{r, cache = TRUE, eval = TRUE}
    gmp14.surowe.dys %>% select(id_testu, k_7447) %>% filter(k_7447 > 0) %>% table()
    ```
  * Wersje testu możemy sprawdzić również pod adresem http://zpd.ibe.edu.pl/doku.php?id=bazatestypytania

    * [ZAAWANSOWANE] możemy użyć tylko składni i funkcji biblioteki *dplyr*;  
    oprócz częstości dodatkowo obliczymy procenty:
        ```{r, cache = TRUE, eval = TRUE}
        gmp14.surowe.dys %>% group_by(id_testu, k_7447) %>% filter(k_7447 > 0) %>% summarize(n = n()) %>% mutate(proc = n / sum(n))
        ```