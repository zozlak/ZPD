---
title: "Wyniki egzaminów"
output:
  html_document:
    highlight: tango
    keep_md: yes
date: "2015.02.02"
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Wyniki egzaminów}
-->
```{r, results = "hide", message = FALSE, warning = FALSE, echo = FALSE}
library(ZPD)
src = polacz()
library('ggplot2')
```

# Surowe wyniki egzaminacyjne

* W postaci _szerokiej_ (takiej, do jakiej jesteśmy przyzwyczajeni):
    * `pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd, punktuj, idSkali, skroc)`
        * w najprostszej postaci: `pobierz_wyniki_egzaminu(src, rodzajEgzaminu, czescEgzaminu, rokEgzaminu, czyEwd)`
* W postaci _długiej_:
    * `pobierz_odpowiedzi(src, idSkali, skroc)`
        * typowo w złożeniu z `semi_join()` na wyniku `pobierz_testy()`

Pobierzmy wyniki części _matematyka_ egzaminu gimnazjalnego z 2014 roku:

1. Sprawdzamy, jaki to rodzaj i część egzaminu - http://zpd.ibe.edu.pl/doku.php?id=czesci_egzaminu
2. Sprawdzamy, czy będą to _dane EWD_ czy _dane CKE_ - http://zpd.ibe.edu.pl/doku.php?id=obazie
3. Pobieramy dane:
```{r, eval = FALSE}
library(ZPD)
src = polacz()

gmm14.sz.surowe = pobierz_wyniki_egzaminu(src, 'egzamin gimnazjalny', 'matematyka', 2014, TRUE) %>%
  collect()

# lub

testy.gmm.14 = pobierz_testy(src) %>%
  filter(rodzaj_egzaminu == 'egzamin gimnazjalny', czesc_egzaminu == 'matematyka', rok == 2014, dane_ewd == TRUE)
gmm14.dl.surowe = pobierz_odpowiedzi(src) %>%
  semi_join(testy.gmm.14) %>%
  collect()
```

Ponieważ pobieranie wyników całej części egzaminu trwałoby zbyt długo, my oszukamy i załadujemy już pobrane zbiory:
```{r, cache = TRUE}
load(url('http://ewd.edu.pl/gmm14.sz.surowe.RData'))
load(url('http://ewd.edu.pl/gmm14.dl.surowe.RData'))
head(gmm14.sz.surowe)
head(gmm14.dl.surowe)
```

## Operacje na wynikach surowych

Mamy już pobrane surowe wyniki na poziomie poszczególnych kryteriów oceny, ale na ogół pracujemy z sumami punktów lub zgoła wystandaryzowanymi sumami punktów. Jak to osiągnąć?

### Sumowanie

```{r, cache = TRUE}
# usuwając zmienne z wynikami za zadania
gmm14.sz.sumy = zsumuj_punkty(gmm14.sz.surowe)
head(gmm14.sz.sumy)
# dołączając dodatkową kolumnę
gmm14.sz.surowe = zsumuj_punkty(gmm14.sz.surowe, FALSE)
head(gmm14.sz.surowe)

# usuwając wiersze z wynikami za zadania
gmm14.dl.sumy = zsumuj_punkty(gmm14.dl.surowe)
head(gmm14.dl.sumy)
# dodając dodatkowe wiersze z sumą
gmm14.dl.surowe = zsumuj_punkty(gmm14.dl.surowe, FALSE)
```

Dla sum punktów wyniki otrzymane z postaci długiej i szerokie powinny być zgodne - sprawdźmy:
```{r, cache = TRUE}
test = gmm14.sz.sumy %>% 
  rename(wynik_sz = wynik) %>% # żeby nie złączyło się po zmiennej "wynik"
  full_join(gmm14.dl.sumy) %>%
  mutate(roznica = wynik - wynik_sz)
head(test)
table(test$roznica)
nrow(test) - nrow(gmm14.dl.sumy)
```

### Normalizacja ekwikwantylowa

Mając dane ze zsumowanymi punktami możemy dokonać normalizacji ekwikwantylowej.

Dostępne są dwie metody:

* Z normami wyliczanymi na podstawie danych.
* Z normami wczytanymi z bazy (wyliczonymi na potrzeby _Kalkulatora EWD_)

#### Normy wyliczane z danych

```{r, cache = TRUE}
gmm14.sz.sumy = normalizuj_ekwikwantylowo(gmm14.sz.sumy, zBazy = FALSE)
```

#### Normy od Kalkulatora EWD

Zastosowanie norm od Kalkulatora EWD wymaga zastosowania _skali_.
_Skala_ opisuje przekształcenia danych takiej jak sumowanie kryteriów oceny czy skracanie skal punktowych.

Musimy zatem:

1. Znaleźć stosowną skalę.
2. Pobrać dane stosując tą skalę.
3. Zsumować punkty
4. Znormalizować.

```{r, cache = TRUE}
# 1. wyszukujemy skalę
pobierz_skale(src) %>%
  filter(normy_ekwikwantylowe == TRUE, rodzaj_egzaminu == 'egzamin gimnazjalny', czesc_egzaminu == 'matematyka', rok == 2014)
# 2. pobieramy dane stosując skalę
  # tak byśmy to zrobili normalnie, ale dziś nie mamy czasu:
  #
  # testy.gmm.14 = pobierz_testy(src) %>%
  #   filter(rodzaj_egzaminu == 'egzamin gimnazjalny', czesc_egzaminu == 'matematyka', rok == 2014, dane_ewd == TRUE)
  # gmm14.skala = pobierz_odpowiedzi(src, 723) %>%
  #   semi_join(testy.gmm.14) %>%
  #   collect()
  #
  # więc zrobimy tak:
  load(url('http://ewd.edu.pl/gmm14.skala.RData'))
# 3. sumujemy
gmm14.skala.sumy = zsumuj_punkty(gmm14.skala)
# 4. normalizujemy
gmm14.skala.sumy = normalizuj_ekwikwantylowo(gmm14.skala.sumy, src, idSkali = 723)
```
h
Porównajmy wyniki przed i po normalizacji:
```{r, cache = TRUE}
ggplot(gmm14.skala.sumy) +
  aes(x = wynik) + 
  geom_density(adjust = 2)
ggplot(gmm14.skala.sumy) +
  aes(x = wynik_norm) + 
  geom_density(adjust = 2)
```

# Pomijanie uczniów przystępujących do egzaminu po raz kolejny 

Czasami (w wypadku EWD na ogół) interesować mogą nas tylko uczniowie piszący dany egzamin po raz pierwszy (na wyjściu) lub ostatni (na wejściu).

Do ich odfiltrowywania służy funkcja `filtruj_przystapienia()`. Dla wskazanego _rodzaju egzaminu_ (lub tylko dla wybranej _części egzaminu_) oraz określenia z jakiego źródła (CKE/OKE) mają pochodzić dane, zwraca ona zbiór zawierający jedynie pierwsze lub ostatnie przystąpienia uczniów do danego egzaminu. Za pomocą złączenia *inner_join* lub filtrowania *semi_join* można dzięki nim odfiltrować pożądane wyniki egzaminu lub oszacowania umiejętności uczniów.

Np. złączmy przygotowane powyżej sumy punktów z informacjami o pierwszym przystąpieniu do egzaminu gimnazjalnego.

* sprawdzając przystąpienia tylko w obrębie części egzaminu _matematyka_ 
* sprawdzając przystąpienia w obrębie całego egzaminu gimnazjalnego

(W obydwu wypadkach dla *danych EWD*, bo właśnie na takich danych mamy policzone sumy punktów)
```{r, cache = TRUE}
filtrMat = filtruj_przystapienia(src, TRUE, 'egzamin gimnazjalny', 'matematyka', TRUE) %>%
  collect()
filtrGim = filtruj_przystapienia(src, TRUE, 'egzamin gimnazjalny', NULL, TRUE) %>%
  collect()
# jeśli nie chcemy czekać, możemy też wczytać już pobrane wyniki:
# load(url('http://ewd.edu.pl/filtry.RData'))
filtrMat

# filtrujemy
gmm14.filtrMat = gmm14.sz.sumy %>%
  inner_join(filtrMat)
gmm14.filtrGim = gmm14.sz.sumy %>%
  inner_join(filtrGim)
# jaka jest różnica w liczbie obserwacji?
# z czego to wynika?
nrow(gmm14.filtrMat) - nrow(gmm14.filtrGim)
```

# Złączanie danych pomiędzy egzaminami

Na wstępie warto zaznaczyć, że **nie wszystkie wyniki egzaminacyjne i oszacowania umiejętności uczniów są łączliwe między latami**. Szczegółowa rozpiska znajduje się pod adresem http://zpd.ibe.edu.pl/doku.php?id=obazie

Tak, czy owak, złączanie następuje wprost po *id_obserwacji* (i co najwyżej nic się nie połączy).

Warto jeszcze zauważyć, że złączane zbiory mogą zawierać jednakowo nazywające się kolumny (np. _wynik_, _dysleksja_, itp.), które przed złączeniem należy przezwać (np. na *wynik_spr*, *wynik_gh*, *dysleksja_spr*, *dysleksja_gh* itd.).

```{r, cache = TRUE}
# przyłączmy do policzonych sum surowych punktów z egzaminu GMM 2014 wyniki sprawdzianu 2011

# pobierzmy wyniki sprawdzianu 2011 (znów oszukując)
load(url('http://ewd.edu.pl/spr11.RData'))
# sumujemy punkty
spr11 = zsumuj_punkty(spr11)
# przezywamy kolumny
spr11 = spr11 %>%
  rename(wynik_spr = wynik, rok_spr = rok, id_testu_spr = id_testu, id_szkoly_spr = id_szkoly)
# złączamy
polaczone = gmm14.sz.sumy %>%
  left_join(spr11)
head(polaczone)
# obliczamy, ile wyników się połączyło
polaczone %>% 
  group_by(is.na(rok_spr)) %>%
  summarize(n = n())
```
